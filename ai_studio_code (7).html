<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>拼图Ultimate (Pro Max)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🐋</text></svg>">
    
    <!-- 依赖库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- 本地样式 -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="antialiased">

    <!-- 拖拽上传遮罩 -->
    <div id="dragOverlay"><div class="text-[#007AFF] font-bold text-2xl bg-white/90 px-6 py-3 rounded-xl shadow-lg">松手释放图片</div></div>

    <!-- 顶部导航 -->
    <header class="sticky top-0 z-50 bg-[#F2F2F7]/90 backdrop-blur-xl border-b border-gray-200/50 supports-[backdrop-filter]:bg-[#F2F2F7]/60">
        <div class="max-w-2xl mx-auto px-5 py-3 flex justify-between items-center h-[52px]">
            <h1 class="text-[22px] font-bold tracking-tight text-black">拼图排序<span class="text-xs font-normal text-white bg-black px-1.5 py-0.5 rounded ml-1">Ultimate</span></h1>
            <div class="flex items-center gap-2">
                <button onclick="window.app.hardReset()" class="bg-gray-100 text-gray-500 text-[13px] font-bold px-3 py-1.5 rounded-full shadow-sm active:bg-gray-200 transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    重置
                </button>
                <button onclick="document.getElementById('fileInput').value=''; document.getElementById('fileInput').click()" class="bg-white text-[#007AFF] text-[15px] font-bold px-4 py-1.5 rounded-full shadow-sm active:bg-gray-100 transition flex items-center gap-1">
                    <svg class="w-4 h-4 stroke-[3px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                    添加
                </button>
            </div>
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="window.app.handleFiles(this.files)">
            <input type="file" id="replaceInput" accept="image/*" class="hidden" onchange="window.app.handleReplaceAction(this.files)">
            <input type="file" id="stickerInput" accept="image/*" class="hidden" onchange="window.app.handleStickerFile(this.files)">
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 pt-4 relative">
        <!-- 进度条提示 -->
        <div id="progressToast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] transition-all duration-200 cubic-bezier(0.34, 1.56, 0.64, 1) -translate-y-[200%] opacity-0 pointer-events-none">
            <div class="bg-white/95 backdrop-blur-xl text-gray-900 rounded-full shadow-2xl flex items-center py-3 pl-6 pr-4 gap-3 border border-gray-200/50 min-w-[200px]">
                <div class="flex-1 flex flex-col justify-center min-w-0">
                    <div class="flex items-center justify-center gap-2">
                        <span id="progressText" class="text-[15px] font-bold leading-tight truncate text-[#007AFF]">准备中...</span>
                    </div>
                </div>
                <button onclick="window.app.cancelProcess()" class="pointer-events-auto w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 active:scale-90 transition text-gray-500 hover:text-[#FF3B30] shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>

        <!-- 图片网格 -->
        <div class="ios-card">
            <details class="group" open>
                <summary class="flex justify-between items-center p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <span class="text-[13px] text-gray-500 uppercase font-medium pl-1">
                        已导入 <span id="countBadge">0</span> 张 
                        <span class="text-[10px] text-[#007AFF] bg-[#007AFF]/10 px-1.5 py-0.5 rounded ml-2 font-bold">长按拖拽 / 自动保存</span>
                    </span>
                    <div class="flex items-center gap-3">
                        <button onclick="event.preventDefault(); event.stopPropagation(); window.app.clearAll()" class="text-[#FF3B30] text-[13px] active:opacity-50 transition hidden" id="clearBtn">清空</button>
                        <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </summary>
                <div class="p-4 pt-0 border-t border-gray-100">
                    <div id="imageGrid" class="grid grid-cols-4 gap-2 overflow-y-auto max-h-[220px] min-h-[100px] no-scrollbar touch-pan-y mt-4">
                        <div id="emptyState" class="col-span-full flex flex-col items-center justify-center py-8 space-y-3">
                            <span class="text-gray-400 text-sm">导入图片 (点击替换/长按排序)</span>
                        </div>
                    </div>
                    <div id="duplicateAlert" class="hidden mt-3 bg-yellow-50 border border-yellow-100 rounded-lg p-3 text-xs text-yellow-700 flex items-start gap-2">
                        <span class="font-bold">发现重复：</span> <span id="dupCount">0</span> 张。
                        <button onclick="window.app.removeDuplicates()" class="underline text-yellow-800 font-bold ml-1">一键去重</button>
                    </div>
                </div>
            </details>
        </div>

        <!-- 单元格设置 -->
        <div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">布局与间距</div>
        <div class="ios-card">
            <details class="group">
                <summary class="flex items-center justify-between p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <div>
                        <div class="text-[17px] font-bold">画布与间距</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">比例、留白</div>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="divide-y divide-gray-200 border-t border-gray-100">
                    <div class="p-4 bg-white flex items-center justify-between">
                        <span class="text-[17px]">画布比例</span>
                        <select id="aspectRatio" onchange="window.app.toggleCustomRatio()" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none text-right appearance-none cursor-pointer dir-rtl">
                            <option value="0.5625">9:16 手机</option>
                            <option value="0.75">3:4 海报</option>
                            <option value="1">1:1 正方</option>
                            <option value="1.333">4:3 照片</option>
                            <option value="custom">自定义...</option>
                        </select>
                    </div>
                    <div class="p-4 bg-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[17px]">图片间隙</span>
                            <span id="gapValueDisplay" class="text-[#007AFF] font-bold text-[15px]">0px</span>
                        </div>
                        <input type="range" id="gap" min="0" max="100" value="0" step="1" oninput="document.getElementById('gapValueDisplay').innerText=this.value+'px'">
                    </div>
                    <div id="customRatioBox" class="hidden p-4 bg-gray-50 flex items-center justify-end gap-3 border-t border-gray-100">
                        <input type="number" id="customW" placeholder="宽" class="bg-white border rounded px-2 py-1 text-center w-20 text-sm" value="1000">
                        <span class="text-gray-400">:</span>
                        <input type="number" id="customH" placeholder="高" class="bg-white border rounded px-2 py-1 text-center w-20 text-sm" value="1500">
                    </div>
                </div>
            </details>
        </div>

        <!-- 序号标注 (升级版) -->
        <div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">序号标注</div>
        <div class="ios-card ios-divide">
            <div class="flex items-center justify-between p-4 bg-white">
                <span class="text-[17px]">显示序号</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="showNum" checked class="sr-only peer">
                    <div class="w-[51px] h-[31px] bg-[#E9E9EA] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-[27px] after:w-[27px] after:shadow-sm after:transition-all peer-checked:bg-[#34C759]"></div>
                </label>
            </div>
            <details class="group">
                <summary class="flex items-center justify-between p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <div>
                        <div class="text-[17px] text-[#007AFF]">详细样式 & 预览</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">字重、描边、透明度</div>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="divide-y divide-gray-200 border-t border-gray-100">
                    
                    <!-- 实时预览区域 -->
                    <div class="p-4 bg-gray-50 flex justify-center items-center">
                        <div class="relative cursor-pointer shadow-md rounded-lg overflow-hidden border border-gray-200" onclick="window.app.enlargeNumberPreview()">
                            <canvas id="numPreviewCanvas" width="200" height="100" class="bg-white block"></canvas>
                            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] text-center py-0.5">点击放大</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">起始数值</span>
                        <!-- 修复点击区域：增加 p-2 和 min-w -->
                        <input type="number" id="startNumber" value="1" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-24 p-2 bg-transparent" placeholder="1">
                    </div>

                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">字体类型</span>
                        <select id="fontFamily" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none appearance-none dir-rtl text-right w-40" onchange="window.app.updateNumberPreview()">
                            <option value="sans-serif">默认 (无衬线)</option>
                            <option value="'Heiti SC', 'Microsoft YaHei', sans-serif">黑体 (Bold)</option>
                            <option value="'Songti SC', 'SimSun', serif">宋体 (Serif)</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="cursive">手写风</option>
                        </select>
                    </div>

                    <!-- 字重选择 -->
                    <div class="p-4 bg-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[17px]">字体粗细</span>
                            <select id="fontWeightSelect" class="text-[#007AFF] text-[17px] bg-transparent focus:outline-none appearance-none text-right dir-rtl" onchange="window.app.toggleCustomWeight()">
                                <option value="300">细体 (Light)</option>
                                <option value="400">常规 (Regular)</option>
                                <option value="bold" selected>粗体 (Bold)</option>
                                <option value="900">特粗 (Black)</option>
                                <option value="custom">自定义...</option>
                            </select>
                        </div>
                        <div id="customWeightBox" class="hidden mt-2">
                            <input type="range" id="customWeightRange" min="100" max="900" step="100" value="700" oninput="window.app.updateNumberPreview()">
                            <div class="text-right text-xs text-gray-400 mt-1">值: <span id="weightVal">700</span></div>
                        </div>
                    </div>

                    <!-- 颜色与描边 -->
                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">字体颜色</span>
                        <input type="color" id="fontColor" value="#FFFFFF" class="w-8 h-8 rounded-full overflow-hidden border border-gray-200" oninput="window.app.updateNumberPreview()">
                    </div>

                    <div class="p-4 bg-white flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-[17px]">描边</span>
                            <input type="checkbox" id="enableStroke" class="accent-[#34C759]" onchange="window.app.updateNumberPreview()">
                        </div>
                        <input type="color" id="fontStrokeColor" value="#000000" class="w-8 h-8 rounded-full overflow-hidden border border-gray-200" oninput="window.app.updateNumberPreview()">
                    </div>

                    <div class="p-4 bg-white">
                         <div class="flex items-center justify-between mb-1">
                            <span class="text-[17px]">不透明度</span>
                            <span id="fontOpacityDisplay" class="text-gray-400 text-sm">100%</span>
                        </div>
                        <input type="range" id="fontOpacity" min="10" max="100" value="100" oninput="document.getElementById('fontOpacityDisplay').innerText=this.value+'%'; window.app.updateNumberPreview()">
                    </div>

                    <div class="flex items-center justify-between p-4 bg-white">
                        <span class="text-[17px]">位置</span>
                        <select id="fontPos" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none appearance-none dir-rtl" onchange="window.app.updateNumberPreview()">
                            <option value="bottom-center">底部居中</option>
                            <option value="bottom-left">底部左侧</option>
                            <option value="bottom-right">底部右侧</option>
                            <option value="center">正中间</option>
                            <option value="top-left">左上角</option>
                            <option value="top-right">右上角</option>
                        </select>
                    </div>
                </div>
            </details>
        </div>

        <!-- 拆分后的导出设置 -->
        <div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">导出设置</div>
        <div class="ios-card">
            <div class="p-4 bg-white border-b border-gray-100">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 relative">
                         <label class="text-[11px] text-gray-500 block mb-1">列数 (Columns)</label>
                         <input type="number" id="cols" value="3" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-2 text-center text-lg font-bold text-[#007AFF] focus:border-[#007AFF] outline-none" oninput="window.app.calculateGroupBatch()">
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 relative">
                         <label class="text-[11px] text-gray-500 block mb-1">每组行数 (Rows)</label>
                         <input type="number" id="group_rows" value="3" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-2 text-center text-lg font-bold text-[#007AFF] focus:border-[#007AFF] outline-none" oninput="window.app.calculateGroupBatch()">
                    </div>
                </div>
                <div class="mt-3 text-[11px] text-gray-500 bg-[#F2F2F7] p-2 rounded flex items-center gap-2" id="group_hint">
                    <span class="font-bold">Ready</span> <span>自动计算中...</span>
                </div>
            </div>
            <div class="p-4 bg-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[17px] font-bold text-gray-800">画质 (Quality)</span>
                    <div class="flex items-center gap-2">
                         <div class="relative w-16">
                            <input type="number" id="customQ_unified" min="10" max="100" value="50" class="bg-gray-100 rounded px-2 py-1 text-center w-full text-[15px] font-bold text-[#007AFF] outline-none" placeholder="50">
                        </div>
                        <span class="text-xs text-gray-500 mr-1">%</span>
                    </div>
                </div>
                <div class="text-[10px] text-gray-400">建议 50%-80%，100% 可能导致文件过大。</div>
            </div>
        </div>

        <!-- 水印与覆盖层 -->
        <div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">水印与底纹</div>
        <div class="ios-card">
            <details class="group">
                <summary class="flex items-center justify-between p-4 bg-white cursor-pointer select-none active:bg-gray-50 transition">
                    <div>
                        <div class="text-[17px] font-bold">覆盖层设置</div>
                        <div class="text-[10px] text-gray-400 mt-0.5">添加水印或 Logo</div>
                    </div>
                    <button onclick="document.getElementById('overlayInput').click()" class="text-[#007AFF] text-[13px] font-bold bg-[#007AFF]/10 px-3 py-1.5 rounded-full active:bg-[#007AFF]/20 transition pointer-events-auto z-10">
                        + 图片
                    </button>
                    <input type="file" id="overlayInput" accept="image/*" class="hidden" onchange="window.app.handleOverlayFile(this.files)">
                </summary>
                <div class="p-4 bg-white border-t border-gray-100">
                    <div id="overlayInfoBox" class="hidden bg-gray-50 rounded-lg p-2 mb-3 flex items-center justify-between border border-gray-100">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <img id="overlayThumb" class="w-8 h-8 rounded object-cover border border-gray-200 bg-white">
                            <span id="overlayName" class="text-xs text-gray-500 truncate max-w-[150px]">filename.png</span>
                        </div>
                        <button onclick="window.app.clearOverlay()" class="text-gray-400 hover:text-[#FF3B30] px-2">✕</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[11px] text-gray-500 block mb-1">混合模式</label>
                            <select id="overlayMode" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-2 py-2 text-sm font-bold text-gray-700 outline-none">
                                <option value="source-over">正常</option>
                                <option value="multiply">正片叠底</option>
                                <option value="screen">滤色</option>
                                <option value="overlay">叠加</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[11px] text-gray-500 block mb-1">不透明度</label>
                            <input type="range" id="overlayOpacityRange" min="0" max="1" step="0.01" value="1" class="w-full h-8">
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- 结果区域 -->
        <div id="resultArea" class="hidden pb-10">
            <div class="ios-card">
                <div class="p-4 bg-white">
                    <div class="text-[17px] font-bold text-[#34C759] mb-2">生成完成</div>
                    <div class="result-scroll-container bg-gray-50/50 rounded-xl overflow-y-auto max-h-[50vh] min-h-[50px] p-2 border border-gray-100">
                        <div id="seamlessContainer" class="w-full flex flex-col bg-white shadow-sm"></div>
                    </div>
                    <div class="grid grid-cols-1 gap-3 mt-4">
                        <button onclick="window.app.confirmDownload('zip')" class="bg-[#007AFF] text-white text-[16px] font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">
                            <span>📦 打包下载 (ZIP) - 推荐</span>
                        </button>
                        <button onclick="window.app.confirmDownload('parts')" class="bg-white text-[#007AFF] border border-gray-200 text-[14px] font-medium py-3 rounded-xl active:scale-95 transition">
                            逐张下载 (防漏图)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="h-24"></div>
    </main>

    <!-- 底部悬浮生成按钮 -->
    <div class="fixed bottom-8 left-0 right-0 px-4 z-40 pointer-events-none">
        <button onclick="window.app.generate()" class="pointer-events-auto w-full max-w-2xl mx-auto bg-white/80 backdrop-blur-md text-black border border-white/40 font-semibold text-[17px] py-3.5 rounded-full shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">
            <span>✨ 开始生成拼图</span>
        </button>
    </div>

    <!-- 隐藏的 Canvas -->
    <canvas id="canvas" class="hidden"></canvas>

    <!-- 图片操作菜单 -->
    <div id="imageActionOverlay" class="modal-overlay" onclick="window.app.closeImageActions()"></div>
    <div id="imageActionSheet" class="action-sheet">
        <div class="text-center text-gray-400 text-sm mb-4 font-medium">图片操作</div>
        <div class="space-y-3">
            <button onclick="window.app.triggerReplace()" class="w-full bg-white text-[#007AFF] font-bold text-[17px] py-3.5 rounded-xl shadow-sm active:bg-gray-50">替换图片</button>
            <button onclick="window.app.triggerDelete()" class="w-full bg-white text-[#FF3B30] font-bold text-[17px] py-3.5 rounded-xl shadow-sm active:bg-gray-50">删除图片</button>
        </div>
        <button onclick="window.app.closeImageActions()" class="w-full bg-white text-black font-semibold text-[17px] py-3.5 rounded-xl shadow-sm mt-4 active:bg-gray-50">取消</button>
    </div>

    <!-- 预览大图 Modal -->
    <div id="previewModal" class="modal-overlay" onclick="this.style.display='none'">
        <div class="bg-white p-2 rounded-xl overflow-hidden shadow-2xl relative flex items-center justify-center flex-col max-w-[90%] max-h-[80%]" onclick="event.stopPropagation()">
            <img id="enlargedPreviewImg" class="object-contain max-w-full max-h-[70vh]">
            <button onclick="document.getElementById('previewModal').style.display='none'" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center">×</button>
        </div>
    </div>

    <!-- 拖拽权限按钮 -->
    <div id="permissionFixBtn" class="fixed top-[70px] right-[20px] z-[999] draggable touch-none">
        <button onclick="window.app.triggerBrowserPermission()" class="bg-[#007AFF] text-white px-3 py-2 rounded-full text-xs font-bold shadow-lg flex items-center gap-1 active:scale-95 transition">
            <span>⚠️ 开启批量下载权限</span>
            <span class="opacity-50 text-[10px]">::</span>
        </button>
    </div>

    <script src="script.js"></script>
    <script>
        // Service Worker 注册
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => console.log('SW Registered')).catch(err => console.log('SW Fail', err));
            });
        }
    </script>
</body>
</html>